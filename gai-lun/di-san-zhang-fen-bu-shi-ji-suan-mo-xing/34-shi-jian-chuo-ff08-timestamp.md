#### 3.4.1 时间戳概念

时间戳是识别特定事情发生时间的字符串或编码信息。它有两个主要功能：第一个与邮戳类似，就是将时间戳在消息上，以证明消息不晚于该时间存在；第二个与骑缝章类似，就是保证里面的信息从盖戳开始没被篡改。由于时间戳是将时间消息"戳"在数字化文档上的数字化证书，它自己本身也是容易被篡改、复制或黏贴的字符串；如果没有一套可靠的加密机制保障，时间戳根本无法发挥邮戳和骑缝章的作用。因此，第二章介绍的哈希函数和数字签名是时间戳实现的关键。

时间戳的概念可能对普通读者来说有些陌生，但它在区块链中非常重要，是确定区块先后顺序的依据。在比特币区块链系统中，时间戳是解决双花问题的第一步：每个节点都是时间戳服务器。经过下一节和第四章的介绍，你们将会意识到比特币的区块链系统其实就是去中心化的TIMESEC时间戳系统。

![](/assets/fig-3-14%2815%29.png)

#### 3.4.2 时间戳实现方法

在最早的论文中，S.Haber和W.S.Stornetta提出了时间戳的两个可能实现方法：Linking和Distributed Trust；前者需要一个中心颁发证书，后者则是无中心的多人验证。接着D.Bayer和S.Haber将Linking方案树状优化了；H.Massias等人又在树状优化的基础上开发了含时间链的TIMESEC系统。由于比特币区块链会在第四章详细介绍，此处将不累述；而Distributed Trust的方法和区块链关系不大，感兴趣的读者可以查阅原文。

##### Linking

> 子贡从战场归来后，写了一本战记。他想证明这本战记是在譬如说公元前500年的正月初八完成而非更晚的时间。假如驿站在春秋时期有现代邮局的功能，子贡便在完成当日将书稿寄给自己，这样驿站将会在书稿上面盖上一个时间戳。

子贡要做的事情置换到虚拟世界，就需要一个类似于驿站的TTS（Time Stamp Service：时间戳服务）机构来完成时间戳的盖印，子贡进行以下的操作：

（1）用哈希函数算出了书稿文档的散列值；

（2）将用户和散列值发给了TSS机构。

TTS机构收到子贡的申请，即和，做了如下操作：

（1）将序号n，盖戳时间，，和链接消息（linking information）	制成证书；其中中又包含了上一个盖戳时间，用户，散列值和上一个链接消息的散列值H\(\);

（2）将数字签名后的证书发送回给子贡；

之后，TTS机构收到了下一个用户子路的申请，即和散列值，在面向子贡的服务它做了最后操作：

（3）将发给子贡

子贡获得签名证书后，只需要解密签名即可知道TTS有没有履行职责；同时他可以将	签名证书和发给任何人来验证她时间戳。

![](/assets/fig-3-16.png)

图3-16：TTS制作时间戳证书所包含的内容。它包含两部分：第一部分收到申请后即可完成发给子贡，第二部分要等到下一位用户申请时才能发给子贡。

![](/assets/fig-3-17.png)

图3-17：Linking流程图

从上面的流程图可以看出，由于证书中含有上一个用户证书的部分消息，可以知道子贡书稿的完成必然发生在时间之后。当子路的申请完成后，他的证书中也会含有子贡证书的消息，那么子贡的证书也必然发生在之前；而且因为子路的证书中也包含了子贡的时间，所以子贡的时间在子路的证书完成后能被篡改的难度增加，除非攻击者与子路及TSS机构合谋。随着时间流逝，由于链接消息不断包含之前链接消息的散列值，越来越多的用户将见证子贡的时间戳以致它能被篡改的成功率越来越小。任何人通过子贡的时间戳证书都可以确定他的书稿在时间时就已经存在了。上述链接消息的概念与之前介绍的哈希链表极为相似。

![](/assets/fig-3-18.png)

图3-18：后面的链接消息都会层层包含前面的链接消息，与哈希链表的结构接起类似。

##### Merkle Tree Style

这是D.Bayer和S.Haber在Linking方案中将链式结构改为了Merkle Tree结构，这样的方案能快速增多目击者（witness），并且能快速查询时间戳证书。

![](/assets/fig-3-19.png)

图3-19：Merkle Tree Style方法示意图。

消息被一层层包含到根部。这个方案类似于巡回比赛，叶节点上的消息两两哈希到上一级；上一级的哈希值再两两哈希到它们的上一级。由于二叉树（binary tree）的性质，根节点与根节点哈希结合就能成为新的二叉树。该方案是像新闻一样不断向全网广播，以让用户申请和查阅。

##### TIMESEC

上述两个方案都是理论，而H.Massias等人在1999年实现的TIMESEC系统就可说的上是比特币区块链的雏形了，虽然它还是中心化的。TIMESEC在每个固定的时间间隔中将接收的申请都以Merkle Tree Style的形式链接起来，时间点与时间点之间的散列值则用类似Linking的方式。

![](/assets/fig-3-20.png)

图3-20：TIMESEC方法示意图。

