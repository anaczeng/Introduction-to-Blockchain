哈希函数是区块链结构的基石之一。为了更好的理解哈希函数的概念、性质和作用，我们继续从子贡记账的例子入手：

> 子贡记账中途出恭，书房里唯留仆人在打扫。当子贡回来时，他产生了这样的疑问：仆人是否在我离开时篡改过账本记录？

解答子贡疑问的方法之一，就是他从头到尾地检查一次账本；但当账本含有上百甚至上千页时，这种方法就并不可取了。当然，子贡还可以采取另一种简单的办法能轻易地发现是否有人翻动过自己的账本，就是他离开前给自己的账本打上封条；当他回来时，只需要检查封条的完整性就可以判断出账本是否被翻动。

在虚拟世界中，哈希函数的作用就类似于上例中的“封条”，而且更为灵敏。它被誉为文件的指纹：只要有一个比特的差异，哈希函数的结果都会发生变化。简单来讲，**哈希函数**是一种可以把任意长度输入转换成固定长度输出的数学函数。举个直观的例子，大家小学时学过的“求余”可看做一种简单的哈希函数：

> 1 mod 7 = 1
>
> 16 mod 7 = 2
>
> 108 mod 7 = 3
>
> 123,781,000 mod 7＝0
>
> 989,800,678,000,000 mod 7＝6
>
> 989,800,684,000,000 mod 7＝6

哈希函数的输入称为**消息（message）**，像上例中等号最左边的1，16等；输出称为**散列值（hash value）**，也可以称为**消息摘要（message digest）**，像等号右边的1，2等。当然，这样的散列值还不足以成为“指纹”。细心的读者肯定发现了989,800,678,000,000和989,800,684,000,000具有相同的散列值6。假如子贡的账本中只有989,800,678,000,000这个数字，那么仆人将中间的78改为84，子贡用mod 7的哈希函数也是没法知道账本记录被篡改了。所以，能制造文件“指纹”的哈希函数还必须具有抗碰撞性。

##### 抗碰撞性（collision-resistance）

不同的消息输入得出相同的散列值输出，就称之为**碰撞（collision）**。像上面例子中的989,800,678,000,000和989,800,684,000,000就发生了碰撞。**抗碰撞性**就是难以发生碰撞的性质。能产生文件“指纹”的哈希函数都必须具备该性质，例如SHA家族和RIPEMD-160。其中SHA-256和RIPEMD-160被大量使用在比特币的区块链中。

特定哈希函数的抗碰撞性并非一层不变。当针对它的碰撞攻击算法出现或计算机计算能力发生质变飞跃时，哈希函数的抗碰撞性就会下降。例如SHA-1的强抗碰撞性已于2005年被攻破，RIPEMD的强抗碰撞性在2004年被攻破，都是因为出现了针对它们的碰撞攻击算法。这意味着这两种哈希函数保护文件一致性的能力下降；若它们的弱抗碰撞性也被攻破时，那就彻底失去作为文件“指纹”的作用了。至今为止，SHA-256和RIPEMD-160还尚未被攻破。

> **强抗碰撞性**：找到相同散列值输出的两条不同消息输入是困难的。
>
> 例如找到
>
> 989,800,678,000,000 mod 7＝6
>
> 989,800,684,000,000 mod 7＝6
>
> 那么mod 7 的强抗碰撞性被攻破。
>
> **弱抗碰撞性**：已知一条消息输入和其散列值输出，找到另一条具有相同散列值输出的不同消息输入是困难的。
>
> 例如已知 989,800,678,000,000 mod 7＝6
>
> 我们找到 989,800,684,000,000 mod 7＝6
>
> 那么mod 7 的弱抗碰撞性被攻破。

哈希函数抗碰撞性可变包含的逻辑是碰撞的客观存在。任意长度的输入空间映射到固定长度的输出空间，必定有多个输入对应同个输出；因为输入空间比输出空间大。以mod 7 为例，输入空间是正无穷，输出空间为7；即使是尚未被攻破的SHA-256的输出空间大到，也远不及输入空间的正无穷大。

![](/assets/fig-2-2.png)

_图 2-2：5个不同消息的输入映射到长度固定为2的输出。由于输入空间（为5）大于输出空间（为），根据鸽笼原理，一一映射是不可能的；也即是存在多个输入对应一个输出的情况，所以碰撞是客观存在的。_

有效碰撞攻击SHA-256的算法尚未出来，所以若想找到相同散列值输出的两个不同消息，必须对个不同消息分别进行SHA-256哈希计算。以现在的计算机速度，至少要年才能完成个消息的哈希计算，有99.8%的可能性找到哈希值相同的两条不同消息[^1]。因此，SHA-256的抗碰撞性被保证了。只有保证哈希函数的抗碰撞性，才能保证文件“指纹”的有效性，也才能预防消息被篡改。[^1]

回到开头的场景：

> 子贡完成记账后，使用哈希封条得到了散列值：
>
> 15 EA F7 67 98 C5 43 7B DF 98 81 54 77 09 4B BE 11 52 37 FF
>
> 他在纸上记下了该值并随身携带。当子贡再次使用账本时，他对比了封条上的哈希值：
>
> 15 EA F7 67 98 C5 43 7B DF 98 81 54 77 09 4B BE 11 52 37 FF
>
> 子贡可以放心账本没有被篡改了。如果封条上的散列值变成了：
>
> 15 EA F7 67 98 C5 43 7B DF 98 81 54 77 09 4B BE 11 52 37 F**E**
>
> 即使只有最后一位不同，子贡也知道仆人趁他不备时篡改了账本。





[^1]: ceshi

