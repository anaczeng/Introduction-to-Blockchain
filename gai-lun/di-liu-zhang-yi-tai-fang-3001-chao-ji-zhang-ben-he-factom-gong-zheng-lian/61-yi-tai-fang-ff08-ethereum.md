#### 6.1.1 以太坊的愿景

以太坊是忠实继承比特币系统去中心化思想的开发平台。简单来说，比特币系统追踪记录的是支付信息，而以太坊追踪记录的是程序；正如比特币系统提供了去中心化的方式来运行货币系统，以太坊为去中心化的应用软件提供了基础设施。以子贡给盗跖发送消息为例，在社交网络模型中信息都要经过中心的服务提供商，但在以太坊模型中，信息被分拆成众多小任务由网络中不同用户协同完成，完成任务的用户会被奖励以太币（ETH）。

![](/assets/fig-6-1-1.png)![](/assets/fig-6-1-2.png)

图6-1：消息传递在社交网络模型与去中心化的以太坊模型。在社交网络模型中，服务提供商的数据中心就是我们常说的“云端”，信息经过时都可存储起来形成公司的资产。在以太坊模型中，整个系统可以看做是个超级大电脑，每个节点只处理信息的一小部分；除了最后的接收者没人可以获取你全部的信息，因为这是一个去中心化的网络。

“流动的数据是未来最大的资产。”这是凯文·凯利的预言。事实上，这个未来已经近在咫尺：如今各大互联网公司最有价值的资产就是用户数据。在手机普及、各类穿戴设备如雨后春笋的今天，用户就像不会干涸的水源，每天产生的数据都被收集上传，而提供服务的互联网公司就成了数据积淀的湖泊。直至现在，用户需要使用服务，数据都别无选择地“免费”成为服务提供商的资产；但以太坊的出现至少提供了一个可能的未来，用户可以自主地管理自己的数据资产，不再被中心化的服务提供商挟持。

以太坊是个非常宏伟的愿景。它的发展不仅可能颠覆各个行业的格局，也会深刻的影响我们日常的生活。例如不久的将来，人们不仅会关注投资理财，还会在意合理地管理自己的数据资产。也正因愿景如此宏伟，新生的以太坊在实现上与白皮书上的设计并不完全一致；同时，它的设计也会随着研究与实验的推进随时可能做出重大的变更。因此，读者在阅读该章节时部分技术内容也许过时了。

![](/assets/fig-6-2.png)

图6-2：以太坊里程碑。

POC阶段一直是演示的样品程序。从前沿（Frontier）开始，以太坊网络正式上线。这个版本面向开发APP的专业编程人员。家园（Homestead）是以太坊现在的版本。现阶段以太坊主要精力都放在调试前沿阶段出现的错误以及消除暴露出来的风险。该版本实际上成了前沿版本的补丁。大都市（Metropolis）尚未知具体的发布日期。计划在该版本中以太坊将配备大量成熟界面和功能，可供普通非技术型用户使用。常态（Serenity）是以太坊现有计划的最后一步。在该阶段中共识机制将完全由POW转成POS，以减少整个网络的能源消耗。

#### 6.1.2 以太坊与比特币

以太坊借鉴了比特币大量的工作。至今以太坊的共识机制依然沿用了POW，它在数据结构方面也与比特币系统的非常相似。比特币系统可以看做是一个隐形的状态（State）转移系统，而以太坊则将状态转移显性地表示出来；它们两者的状态转移过程都靠交易（transaction）完成。

![](/assets/fig-6-3.png)

图6-3：比特币系统的状态转移。

比特币系统中每个地址的状态（所含比特币）都可以通过跟该地址相关的所有交易信息推断出来。地址状态并不包含在账本中，所以它是隐性的。而在以太坊中，状态（State）都由账户（Account）这种具体的数据结构构成，并存储在所有全节点的账本中。以太坊的数据结构将在下一节具体介绍。

#### 6.1.3 账本

以太坊的账本也是区块链结构，只是在比特币的基础上做了修改。例如区块中不仅包含交易的集合，还包含叔区块的集合。叔区块（Uncle Block）类似于比特币中的孤儿块，但它所包含的算力会用在以太坊的共识机制中。

![](/assets/fig-6-4.png)

图6-4：以太坊账本概览示意图。

##### 6.1.3.1 区块与区块头

以太坊的区块包含三部分：区块头，交易列表和叔区块列表。以太坊的区块头比区块链要复杂得多，它包含了15个域；除了使用哈希指针和Merkle树的数据结构外，还引入了Merkle-Patricia树这种新的数据结构。此外，以太坊的哈希函数使用的是SHA-3。

表6-1：区块头每部分功能介绍。

![](/assets/fig-table-6-1.png)![](/assets/fig-6-5.png)

图6-5：以太坊区块头与Merkle-Patricia树示意图。

##### 6.1.3.2  账户

账户是以太坊的核心概念：以太坊是个状态转移系统，而账户包含了状态信息。以太坊有两类账户：外部持有账户和交易账户。外部持有账户（Externally owned account, EOA）由私钥控制，掌握私钥的用户可以从账户中转移以太币或发送消息。合约账户（Contract account）由代码控制，消息可驱动它的内含代码。交易账户可以读写自己的内存数据、发送消息和产生新的交易。合约账户主要以下四个功能：存储对其他交易或外部世界有用的信息；作为复杂交易的中间步骤；管理协调多个用户之间的关系和作为软件库。

表6-2：账户每部分功能的介绍。

![](/assets/fig-table-6-2.png)

##### 6.1.3.3 交易与消息

交易（transaction）与消息（message）的主要区别在于前者由外部持有账户发送而后者是由合约账户发送。

表6-3：交易各部分功能介绍。

![](/assets/fig-table-6-3.png)

表6-4：消息各部分功能介绍。

![](/assets/fig-table-6-4.png)

#### 6.1.4 智能合约

智能合约是以太坊的核心功能，它主要是通过账户实现的。下面以第一章中子贡和房东之间建立的短期租约为例：

```
子贡以1BTC一天的价格租用三天房子。
```

图6-9：智能合约实现过程示意图。蓝色方框代表合约账户，红色方框代表外部持有账户。蓝色箭头代表消息，红色箭头代表交易，黑色箭头代表与外部系统的交互。该例是以子贡发送交易开始执行智能合约，所以房东部分仅以连线代表信道，但并没有发送任何交易或信息。

（1）    子贡使用EAO给租房合约发送了交易；

（2）    租房合约被触发，它与验证签名交互以验证子贡的私钥签名；

（3）    租房合约向合约发送消息；

（4）    合约中的代码被触发，它通过接口与外部比特币系统交互，成功将3BTC从子贡地址转到房东地址；

（5）    合约与外部子贡的移动端交互，它发送“钥匙”到子贡移动端并收到回执；

（6）    合约发送消息到租房合约，租房合约发送消息到子贡的EAO。

6.1.5 共识机制

以太坊现阶段依然沿用了比特币POW的共识机制，但它计划在常态时期转为POS。以下介绍内容是以太坊为今后共识机制的改变做的探索。

6.1.5.1 从幽灵（GHOST）到友善小精灵（Casper）

这里的GHOST即不是我们常用于重装系统的磁盘克隆也不是《攻壳机械队》里的灵魂，而是一种称为贪心最重观察子树（Greedy Heaviest-Observed Sub-Tree）的共识机制。GHOST在比特币确认主链的机制上做了修改，以求获得更快的出块速度（理论上可达到一秒出一区块的速率），最终达到提高整个网络交易吞吐量的目的。

比特币以“最长”链为主链。这就需要在出块速率与主链不可推翻性（irreversibility）之间做出权衡：出块率增高则孤儿块出现率也增高，系统中将会有大量的算力浪费在不能确保主链安全的旁支区块中。比特币系统十分钟一个区块的出块率便是这种权衡的结果。

GHOST将非主链区块中的算力也贡献到主链的不可推翻性上：当区块产生分叉时，以它为根的子树所包含的所有算力都用于确保它加入主链中。在下图中，区块B、、、和组成了一棵以B为根的子树，它包含了5个区块的算力；而区块、、和组成的链条只包含了4个区块的算力。因此，B被包含在主链中，区块等则非主链区块，尽管包含它们的支链更“长”。GHOST具有“区块要不被全部节点接收，要不被全部节点废弃”的性质，所以最后网络中的所有节点都会对过去发生的历史保持一致性。

图6-6：在GHOST机制中，区块B将被包含在主链中；而在比特币机制中，红色的区块将被包含在主链。

Casper是GHOST的POS变种，它以股权以太币作为主链的度量。在Casper中类似矿工的角色称为“锁定保证金的验证人”（Bounded Validator），他们必须缴纳保证金才能参与出块和共识的形成。Capser的共识类似于赌博下注，验证人以保证金为他们预测的主链区块下注：若签名的区块非主链区块，验证人将失去保证金；反之，则能取回保证金并获得额外奖励。

图6-7：Casper共识机制示意图。

在T-1阶段，子贡和子路都为区块下注，而伯牛和子有为区块B下注。在T阶段，子贡认为区块将成为主链区块，并在其后的区块下注；而子路认为区块B将成为主链区块，转为和伯牛一起在其后的区块下注。这时，以区块B为根的子树包含了大多数的股权，它成为了主链区块，区块和则被废弃。在T+1阶段，子贡，子路和伯牛都认为将成为主链区块，并在其后的区块下注，这时候区块和成为主链区块的优势明显，到了T+2阶段，所有验证人都在区块下注。这时链条收敛，主链包含了区块A、B、、和。虽然在主链确认过程中使用到“树”的结构，但最后达成共识的依然是一条“链”的结构。此外，为了避免分叉一直存在，即子贡、子路和伯牛、子有的下注分歧一直存在，以太坊规定验证者只能取回部分保证金如果不能迅速达成一致下注。

6.1.5.2 分片（Sharding）

分片也是为了增强网络扩展性而做出的尝试。它的基本思想就是将全网节点随机地分配到多个片区（Shards），每个片区负责处理当前状态的部分交易；也即是整个网络中将不再只有一条区块链，而是存在多条内在相关的链条。理想状态下，一个节点也只保存该片区或部分片区的账本。对于它持有账本的片区来说，该节点是全节点；而对其他片区来说，它又是依靠SPV验证的轻节点。比特币系统可以看做是只有一个片区的特殊情况。

图6-8：引入Sharding的网络可以采用类似于BGP的协议传递消息。节点C要给节点D传递消息就需要通过类似于节点A和B这类边界路由。

6.1.6 蜂群（Swarm）和低语者（Whisper）

蜂群是去中心化存储，低语者是去中心化通讯，以太坊的合约是去中心化的逻辑。简单来说，若将以太坊想象成一个“全球电脑”，蜂群就是它的存储协议，低语者是它部件之间的通讯协议。现阶段的蜂群和低语者仍处于孵化阶段。

