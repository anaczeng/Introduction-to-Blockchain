#### 7.1.1 区块链的症结：1M限容

1M限容是指比特币账本每个区块大小不得超过1MB，这是设计之初中本聪为了防止恶意矿工产生大区块而做出的限制。这种限制本质上是在交易并发量和全节点数量间做出权衡。

现在区块链的TPS为7笔，相比Visa在高峰期的TPS为47,000笔，两者根本不在一个数量级。在今年（2016）的上海区块链国际周上，TPS过低已成为区块链在各领域中进入实际应用的主要障碍。除了前面提到的PBFT外，针对比特币区块链的闪电网技术以及针对以太坊平台的雷电网技术就成了解决这方面问题的急先锋。

也许有人提出，为什么不能直接简单地将1M限容的限制去除呢？或者就如Mike Hearn提出的将每区块的限制容量直接提升到20MB。这个提议只能缓解矛盾，它不能使TPS达到数量级的增长；而且面对现在65GB大小并会越来越大的比特币账本，普通的全节点开始纷纷退出网络：一是相比挖矿节点，全节点并无利益可图；二是越来越大的存储要求让人心生惧意。即使现在还没有扩容，全球全节点的个数已经下降到5000多个已是一个很明显的警示。

#### 7.1.2 闪电网的思想

闪电网解决TPS过低问题的核心思想是**将尽可能多的交易转移到链下（off-chain）进行**。它为交易双方提供了一个可扩展的微支付通道，也即是除了第一笔和最后一笔需要提现的交易需要记录在区块链上，其他的交易都通过链下的微支付通道记录。这个微支付通道也相当于一本只关乎交易双方的链下私有账本。闪电网的思想来源于商业信用：让交易双方周期性地将产生的大量小额交易联合成一个大额交易。

#### 7.1.3 闪电网的具体实现

闪电网的具体实现包含三方面：RSMC（Recoverable Sequence Maturity Contract），HTLC（Hashed Timelock Contract）和闪电网络。RSMC是三者中最基础的实现，只支持无条件资金支付；HTLC可支持有条件的资金支付。实现RSMC和HTLC的最终目的就是实现闪电网络：交易双方即使没有建立微支付通道，也能实现资金支付。

##### 7.1.3.1 RSMC：序列到期可撤销合约

子贡和卫国钱庄每天都有频繁的资金往来。为了方便，他们大部分的交易并无真正的资金流动，只是在账面上做了记录；只有到清算日，双方把帐算清，亏欠的一方付给盈余的一方。譬如，子贡正月一日付卫国钱庄100两黄金，正月二日付卫国钱庄50两黄金；正月三日卫国钱庄付子贡200两黄金。正月四日是清算日，三笔帐合起来即为卫国钱庄应付子贡50两黄金。真正的资金流动就是在清算日时，卫国钱庄付给子贡的20两黄金。

RSMC的原理与上例相似。减少资金流动的手续在RSMC中即减少在比特币主链上的记录。RSMC是闪电网的基础，定义了微支付通道的基本工作步骤。让我们来看一个简化的例子如何在RSMC中实现的：

子贡每天付给卫国钱庄0.1BTC，而卫国钱庄每天也许转给子贡0.1BTC，每晚清算销账。

每天早上使用RSMC构建微支付通道：

（1）子贡和卫国钱庄互换公钥、和地址、，产生一个多重签名地址，多种签名地址的介绍可回顾5.1.2.4节内容；

（2）用于建立筹资交易（Funding Tx）：子贡和卫国钱庄都将0.1BTC打入该地址但此时双方都并未签名；

![](/assets/fig-7-1.png)

图7-1：Funding Tx的示意图，灰色代表子贡和卫国钱庄都尚未签名。Funding Tx与拆分成子贡和卫国钱庄分别打0.1BTC进入多重签名地址的两个普通交易效果是一样的。

（3a）子贡用自己的第二个公钥和卫国钱庄的产生第二个多重签名地址并依次构建承诺交易（Commitment Tx）和可撤销投递交易（Revocable Delivery Tx）。的输入是（2）中建立的筹资交易，输出有两个：①将0.1BTC打入地址，②将0.1BTC打入卫国钱庄地址。的输入是①，输出是将0.1BTC打入子贡地址。此后，子贡用签名和签名，并发给卫国钱庄；

![](/assets/fig-7-2%283%29.png)

（3b）卫国钱庄操作流程和子贡一样，先获得多重签名地址，然后构建交易和并签名发给子贡；

![](/assets/fig-7-4%285%29.png)

（4）子贡使用和卫国钱庄使用签名（2）中的筹资交易并将其广播。

至此，子贡与卫国钱庄之间的微支付通道建成。

![](/assets/fig-7-6.png)

图7-6：使用RSMC建立微支付通道。筹资交易已被签名广播，而承诺交易皆缺一方签名尚未广播。红色方框的交易是由子贡创建签名后发给卫国钱庄，蓝色反之。

RSMC微支付通道设立繁琐，有以下几点是值得注意的：

1. 筹资交易在完成承诺交易才双方签名广播是为了防止一方中途拒绝合作让另一方资金锁在多重签名地址内的情况发生。当交易双方交换已有一方签名的承诺交易后，只要有一方拒绝合作，另一方只需要签名承诺交易并广播，资金就会退回各自的地址。

2. 承诺交易和的输入使用了序列号，序列号是为了推迟交易进块而设立的。在上例中，假如子贡签名了交易和并广播，那么交易要在交易被1000个区块确认之后才能被矿工打包进块。这也意味着子贡要比卫国钱庄晚1000个区块的时间才能收到资金。序列号的设置是为了让交易双方尽可能多的使用链下微支付通道，提前关闭通道的一方将受到惩罚。

3. 子贡和卫国钱庄分别创建的承诺交易是一对软分叉。这也意味着只有一组承诺交易能被打包进块，但两组交易的资金分配是一致的。

子贡需要向卫国钱庄支付0.1BTC：

（5）子贡用自己的第三个公钥和卫国钱庄的产生新的多重签名地址；

（6）子贡创建新的交易和，并创建比优先级更高的违约补偿交易（Breach Remedy Tx）。子贡签名、和后发给卫国钱庄。

![](/assets/fig-7-7%288,9%29.png)

（7）卫国钱庄获得后，创建交易和并签名后发给子贡；

![](/assets/fig-7-10%2811%29.png)

至此，子贡向卫国钱庄的支付完成。

![](/assets/fig-7-12.png)

图7-12：子贡向卫国钱庄支付0.1BTC，RSMC微支付通道状态更新示意图。红色方框的交易是由子贡创建签名后发给卫国钱庄，蓝色反之。交易的

开通微支付通道后的交易是撤销之前交易更新双方余额状态的过程。按照业务逻辑，之前的交易、和、都应作废，由新的交易、和、取代；但是在技术层面，交易、、、和交易、、、是一样的。如何防止子贡后面反悔执行交易和，这里引入交易。假如子贡执行了交易和，交易马上入块，但是交易要在交易被1000个块确认后才能入块。在这大约10000分钟内，卫国钱庄发现了子贡的欺诈行为马上执行。是可以马上入块的，这时子贡就会失去所有资金。

卫国钱庄向子贡支付0.1BTC：（8）-（10）步骤与前面子贡支付卫国钱庄的过程相同。

![](/assets/fig-7-13.png)

图7-13：卫国钱庄向子贡支付0.1BTC，RSMC微支付通道状态更新示意图。红色方框交易由子贡创建签名后发给卫国钱庄，蓝色反之。

一天结束后需要销账，也即是关闭通道的过程。假如由子贡执行：

（11）子贡签名交易和并广播全网。

![](/assets/fig-7-14.png)

图7-14：RSMC微支付通道关闭。子贡签名和并广播，很快被区块n确认，卫国钱庄收到0.1BTC。当经过1000个区块确认后，被区块n+1000确认，子贡收到0.1BTC。

当交易入块后，卫国钱庄地址收到了0.1BTC；当交易经过1000块确认后，交易入块，子贡地址收到0.1BTC。至此，子贡和卫国钱庄之间的RSMC微支付通道完全关闭。

从上述例子可看出，通过RSMC的微支付通道，除了筹资交易和最后一次的承诺交易和可撤销投递交易需要记录在区块链外，其他的交易都可在链下进行，不用在区块链上执行。当然，上例中的子贡和卫国钱庄还可以每月销账一次，或每季甚至每年；随着微支付通道存在的时间越久，区块链上需要记录的交易就越少。这样就可以解决TPS过低的问题。

##### 7.1.3.2 HTLC：哈希时间锁定合约

HTLC是在RSMC的基础上支持有条件支付，是构建下一节闪电网络的核心合约。它的思想并不复杂：如果接收方在规定时间内提交双方约定的秘密R，则支付方锁定的资金将打入接收方地址；否则逾期资金将返还支付方。

```
子贡锁定฿（比特币）
If 卫国钱庄在T（时间）内提交秘密R
    立即支付卫国钱庄 ฿
Else
    T后返还子贡 ฿
```

尽管HTLC只有两个可能的结果，但它的实现非常的繁琐。我们以“子贡向卫国钱庄发送0.1BTC”为例介绍实现步骤：

（1）    卫国钱庄生成秘密R，并向子贡发送秘密的散列值H（R）；

（2）    在HTLC中，由支付者子贡广播交易和由接收者卫国钱庄广播交易的后续实现是不一样的。下面就分别从这两方面来介绍HTLC合约的具体实现。

![](/assets/fig-7-15.png)

图7-15：HTLC流程示意图，虚线以内是HLTC合约的构建。红色方框交易由子贡创建签名后发给卫国钱庄，蓝色反之。时间锁和序列号都使用了区块高度，1000个区块确认大概是16小时。

由支付者广播承诺交易：

子贡广播交易后，如果卫国钱庄能在16小时内广播含有秘密R的交易，他就能获取0.1BTC；如果卫国钱庄未能履约，子贡在16小时后可广播交易，当交易被1000个区块确认后，交易被区块确认，子贡得到0.1BTC的资金返还。

由接收者广播承诺交易：

卫国钱庄广播交易后，如果他能在16小时内广播含有秘密R的交易,在交易被1000个区块确认后，交易被区块确认，卫国钱庄获得0.1BTC。假如卫国钱庄未能履约，子贡在16小时候广播交易，她很快就获得0.1BTC的资金返还。

##### 7.1.3.3 闪电网络

微支付通道的建立步骤繁琐，若要在每两个用户间都建立通道，显然不现实。闪电网络可以让资金通过多个节点流动而避免建立直接的通道，请看下面例子：

子贡向卫国钱庄支付0.1BTC。虽然子贡与卫国钱庄之间没有建立直接的微支付通道，但他俩已分别和鲁国钱庄建立了通道。

闪电网络的实施步骤如下：

（1）    卫国钱庄生成秘密R，并向子贡发送秘密散列值H（R）；

（2）    子贡和鲁国钱庄建立合约：只要鲁国钱庄在2天内广播含有秘密R的交易，子贡将支付给鲁国钱庄0.11BTC，否则将原款退回子贡；

（3）    鲁国钱庄和卫国钱庄建立合约：只要卫国钱庄在1天内广播含有秘密R的交易，鲁国钱庄将支付给卫国钱庄0.1BTC，否则将原款退回鲁国钱庄；

（4）    卫国钱庄在1天内广播了含有秘密R的交易，获得了0.1BTC；

（5）    鲁国钱庄在2天内广播了含有秘密R的交易，获得了0.11BTC。

![](/assets/fig-7-16.png)

图 7-16：闪电网络步骤示意图。

#### 7.1.4 闪电网的忧虑

闪电网技术在社区受到追捧，其白皮书甚至被誉为除中本聪原文外对比特币最重要的论文；但从上面的介绍来看，闪电网的实现让人有较多的忧虑：

1. 实现步骤复杂繁琐。在未经时间验证前，闪电网的安全性和实用性仍值得商榷。

2. 闪电网能否解决“TPS过低”的问题也值得斟酌。闪电网的假设是存在大量的小额交易能在链下进行，而不需要链上记录；通道存在时间越长，效果越好。但用户不一定愿意长时间地保留通道，因为保留通道意味着保证金要沉淀在通道中，某种程度上这让资金的流动性受阻。其次，闪电网络的建立严重依赖活跃用户数量。若用户过少，那么任意两个用户很有可能处于隔离状态。这又降低了用户保留通道的意愿：用户保留的通道越多，他被分散沉淀在通道中的保证金就越多。此外，很多小额交易都是一锤子买卖，两个用户间并不产生长期多次的交易。一次性的支付，闪电网不仅不能减少链上的交易记录，反而是原来的三倍：需要筹资交易，承诺交易和可撤销投递交易才能完成支付。

![](/assets/fig-7-17.png)

图7-17：实线表示初始时存在的微支付通道，虚线表示新增的通道。在初始状态下，子贡、子路及子有和伯牛、孔子是隔离的。若孔子要支付子贡，他俩必须新建通道。在上例中，子贡需支付7BTC保证金建立与子贡的新通道，那么他极有可能关闭与伯牛的通道，提现7BTC用于新通道建设。

